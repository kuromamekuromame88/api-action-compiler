<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Microcontroller IDE</title>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.15/lib/codemirror.css">
  <script src="https://unpkg.com/codemirror@5.65.15/lib/codemirror.js"></script>
  <script src="https://unpkg.com/codemirror@5.65.15/mode/clike/clike.js"></script>
  <script src="https://unpkg.com/codemirror@5.65.15/mode/properties/properties.js"></script>

  <style>
    body {
      margin: 0;
      background-color: #1e1e1e;
      color: #ddd;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: #333;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .toolbar button {
      margin-right: 10px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 6px 12px;
      cursor: pointer;
    }

    .toolbar button:hover {
      background: #008cff;
    }

    .tab-bar {
      background: #2d2d2d;
      display: flex;
      border-bottom: 1px solid #444;
    }

    .tab {
      padding: 8px 15px;
      cursor: pointer;
      border-right: 1px solid #444;
      background: #2d2d2d;
      color: #bbb;
    }

    .tab.active {
      background: #1e1e1e;
      color: #fff;
      font-weight: bold;
    }

    #editor {
      flex: 1;
    }

    footer {
      background: #222;
      padding: 8px 15px;
      font-size: 0.9em;
      color: #bbb;
    }
  </style>
</head>
<body>
  <header>
    <div>ğŸ§  Web Microcontroller IDE</div>
    <div class="toolbar">
      <button id="newBtn">æ–°è¦</button>
      <button id="saveBtn">ä¿å­˜</button>
      <button id="uploadBtn">ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«</button>
      <button id="flashBtn">æ›¸ãè¾¼ã¿</button>
    </div>
  </header>

  <!-- ã‚¿ãƒ–ãƒãƒ¼ -->
  <div class="tab-bar" id="tabBar">
    <div class="tab active" data-file="sketch.cpp">sketch.cpp</div>
    <div class="tab" data-file="platformio.ini">platformio.ini</div>
  </div>

  <div id="editor"></div>

  <footer>
    <span id="status">æº–å‚™å®Œäº†</span>
  </footer>

  <script>
    // å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹
    const files = {
      "sketch.cpp": `#include <Arduino.h>

void setup() {
  Serial.begin(115200);
}

void loop() {
  Serial.println("Hello, PlatformIO!");
  delay(1000);
}`,
      "/*ãƒœãƒ¼ãƒ‰IDã¯ã“ã¡ã‚‰ã®URLã‹ã‚‰èª¿ã¹ã‚‰ã‚Œã¾ã™â†’https://docs.platformio.org/en/latest/boards/index.html*/\nplatformio.ini": `[env:esp32-s3-devkitc-1]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
upload_speed = 921600
monitor_speed = 115200`
    };

    let currentFile = "sketch.cpp";

    // CodeMirroråˆæœŸåŒ–
    const editor = CodeMirror(document.getElementById("editor"), {
      value: files[currentFile],
      mode: "text/x-c++src",
      lineNumbers: true,
      theme: "default",
      tabSize: 2,
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        // ç¾åœ¨ã®ã‚¨ãƒ‡ã‚£ã‚¿å†…å®¹ã‚’ä¿å­˜
        files[currentFile] = editor.getValue();

        // æ–°ã—ã„ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        currentFile = tab.dataset.file;
        editor.setValue(files[currentFile]);
        editor.setOption("mode", currentFile.endsWith(".ini") ? "text/x-properties" : "text/x-c++src");
        setStatus(`${currentFile} ã‚’ç·¨é›†ä¸­`);
      });
    });

    // æ–°è¦ãƒœã‚¿ãƒ³
    document.getElementById("newBtn").onclick = () => {
      if (confirm("æ–°ã—ã„ã‚¹ã‚±ãƒƒãƒã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) {
        files["sketch.cpp"] = "#include <Arduino.h>\n\nvoid setup() {\n}\n\nvoid loop() {\n}";
        editor.setValue(files[currentFile]);
        setStatus("æ–°ã—ã„ã‚¹ã‚±ãƒƒãƒã‚’ä½œæˆã—ã¾ã—ãŸ");
      }
    };

    // ä¿å­˜ãƒœã‚¿ãƒ³
    document.getElementById("saveBtn").onclick = () => {
      files[currentFile] = editor.getValue();
      const zipContent = {
        "sketch.cpp": files["sketch.cpp"],
        "platformio.ini": files["platformio.ini"]
      };

      // 2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦zipåŒ–
      const zip = new JSZip();
      for (const [name, content] of Object.entries(zipContent)) {
        zip.file(name, content);
      }
      zip.generateAsync({ type: "blob" }).then(blob => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "project.zip";
        a.click();
      });
      setStatus("ä¿å­˜ã—ã¾ã—ãŸï¼ˆZIPï¼‰");
    };
    
    function setStatus(text) {
      document.getElementById("status").textContent = text;
    }

    // JSZipã‚’èª­ã¿è¾¼ã¿
    const jszipScript = document.createElement("script");
    jszipScript.src = "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";
    document.head.appendChild(jszipScript);


    
async function compileProject() {
  files[currentFile] = editor.getValue();
  setStatus("ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«é–‹å§‹ä¸­...");

  // ZIPç”Ÿæˆ
  const zip = new JSZip();
  for (const [name, content] of Object.entries(files)) {
    zip.file(name, content);
  }
  const zipBlob = await zip.generateAsync({ type: "blob" });

  // ZIP â†’ Base64åŒ–ï¼ˆGitHub APIã«é€ã‚‹ãŸã‚ï¼‰
  const reader = new FileReader();
  const base64 = await new Promise(resolve => {
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(zipBlob);
  });

  // ã“ã“ã§ GitHub Actions ã‚’ãƒˆãƒªã‚¬ãƒ¼
  // ã‚ãªãŸã®ãƒªãƒã‚¸ãƒˆãƒªã® API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›´ã™ã‚‹
  const apiUrl = "https://api.github.com/repos/<YOUR_USERNAME>/<YOUR_REPO>/dispatches";

  const payload = {
    event_type: "build_request",
    client_payload: {
      project_zip: base64
    }
  };

  const token = "<YOUR_GITHUB_PAT>"; // ä»®: å¾Œã§å®‰å…¨ãªå ´æ‰€ã‹ã‚‰å–å¾—ã™ã‚‹

  try {
    const res = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": `token ${token}`,
      },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      setStatus("GitHub Actionsã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’ä¾é ¼ã—ã¾ã—ãŸã€‚çµæœã‚’å¾…ã£ã¦ã„ã¾ã™â€¦");
    } else {
      setStatus("ã‚¨ãƒ©ãƒ¼: GitHub APIã«é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸ");
      console.error(await res.text());
    }
  } catch (err) {
    console.error(err);
    setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
  }
}

  document.getElementById("uploadBtn").onclick = compileProject;
</script>
</body>
</html>
